<?php 
require_once 'config.php';
session_start();

// Check if logged in
if (!isset($_SESSION['voterID'])) {
    header('Location: index.php');
    exit;
}

$voterID = intval($_SESSION['voterID']);

// Check voter eligibility
$voterCheck = mysqli_query($conn, "SELECT voted, voterStat FROM voters WHERE voterID = $voterID");
$voterData = mysqli_fetch_assoc($voterCheck);

if (!$voterData) {
    session_destroy();
    die("Voter not found. <a href='index.php'>Return to Login</a>");
}

if ($voterData['voted'] === 'y') {
    session_destroy();
    die("You have already voted. <a href='index.php'>Return to Login</a>");
}

if ($voterData['voterStat'] !== 'active') {
    session_destroy();
    die("Your account is inactive. <a href='index.php'>Return to Login</a>");
}

// Handle logout
if (isset($_GET['logout'])) {
    session_destroy();
    header('Location: index.php');
    exit;
}

// Handle vote submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['submit-vote'])) {
    
    // Collect all votes from radio buttons
    $selectedVotes = array();
    foreach ($_POST as $key => $value) {
        if (strpos($key, 'vote_') === 0 && !empty($value)) {
            $selectedVotes[] = intval($value);
        }
    }
    
    if (empty($selectedVotes)) {
        $error = "Please select at least one candidate.";
    } else {
        // Record votes
        foreach ($selectedVotes as $candID) {
            mysqli_query($conn, "INSERT INTO votes (voterID, candID) VALUES ($voterID, $candID)");
        }
        
        // Mark voter as voted
        mysqli_query($conn, "UPDATE voters SET voted = 'y' WHERE voterID = $voterID");
        
        session_destroy();
        
        echo "<h2>Success!</h2>";
        echo "<p>Your vote has been recorded successfully!</p>";
        echo "<a href='index.php'>Return to Login</a>";
        exit;
    }
}

// Display voting form
?>

<h2>Voting System</h2>

<?php if (isset($error)): ?>
    <p style="color: red;"><?php echo $error; ?></p>
<?php endif; ?>

<form method='POST'>
    <?php
    // Get all open positions
    $positions = mysqli_query($conn, "SELECT * FROM positions WHERE posStat = 'open' ORDER BY posID");
    
    while ($pos = mysqli_fetch_assoc($positions)) {
        echo "<h3>" . htmlspecialchars($pos['posName']) . " (Select 1)</h3>";
        
        // Get active candidates for this position
        $candidates = mysqli_query($conn, "SELECT * FROM candidates WHERE posID = {$pos['posID']} AND candStat = 'active'");
        
        if (mysqli_num_rows($candidates) > 0) {
            while ($cand = mysqli_fetch_assoc($candidates)) {
                $fullName = htmlspecialchars(trim($cand['candFName'] . ' ' . $cand['candMName'] . ' ' . $cand['candLName']));
                echo "<label>";
                echo "<input type='radio' name='vote_{$pos['posID']}' value='{$cand['candID']}'>";
                echo " $fullName";
                echo "</label><br>";
            }
        } else {
            echo "<em>No candidates available</em><br>";
        }
        
        echo "<br>";
    }
    ?>
    
    <button type='submit' name='submit-vote'>Submit Vote</button>
</form>

<br><a href='?logout=1'>Logout</a>